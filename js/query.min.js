function Query(a,b){this._serverIP=a;this._serverPort=b;$("#team_information").hide()}Query.prototype._prevStatus={};Query.prototype._activityHistory=[0,0,0,0,0,0,0,0,0,0];Query.prototype._soundQueue=[];Query.prototype._consecutiveFailures=0;Query.prototype._firstRun=true;Query.prototype._soundQueueLock=false;Query.prototype.setIntervalHandle=function(a){this._intervalHandle=a};Query.prototype.transferStatus=function(a){this._prevStatus=a};Query.prototype.getStatus=function(){return this._status};Query.prototype.update=function(){var a=this;jQuery.ajax({url:"script/ajax.php",type:"POST",data:{ip:a._serverIP,port:a._serverPort},success:function(b){a._status=jQuery.parseJSON(b);if(!a._status.error){a._updateUI();a._audioCues();a._saveStatus();a._firstRun=false}else{a._errorHandler()}},error:function(b){a._errorHandler()}})};Query.prototype._updateUI=function(){if(this._firstRun){this.displayTabs()}this._pageTitle();this._playerActivitySpark();this._teamInformation();this._serverInformation();if(this._status.mapname!=this._prevStatus.mapname){this._mapImages()}if(this._status.gametype!=this._prevStatus.gametype||this._status.gamevariant!=this._prevStatus.gamevariant){this._playerSettings();this._gameSettings();this._vehicleSettings();this._gameIcon()}};Query.prototype._playerSettings=function(){$("#lives").text(this._status.flags.Player.NumberOfLives);$("#health").text(this._status.flags.Player.MaximumHealth);$("#shields").text((this._status.flags.Player.Shields?"Yes":"No"));$("#respawn_delay").text(this._status.flags.Player.RespawnTime+" seconds");$("#respawn_growth").text(this._status.flags.Player.RespawnGrowth+" seconds");$("#odd_man_out").text((this._status.flags.Player.OddManOut)?"Yes":"No");$("#suicide_penalty").text(this._status.flags.Player.SuicidePenalty+" seconds");$("#weapon_set").text(this._status.flags.Player.WeaponSet);$("#starting_equipment").text(this._status.flags.Player.StartingEquipment);$("#juggernaut").text((this._status.flags.Player.InvisiblePlayers)?"Yes":"No");$("#infinite_quadnading").text((this._status.flags.Player.InfiniteGrenades)?"Yes":"No");$("#nav_points").text(this._status.flags.Player.Indicator);$("#radar_mode").text(this._status.flags.Player.OtherPlayersOnRadar);$("#friend_indicators").text((this._status.flags.Player.FriendIndicators)?"On":"Off");$("#friendly_fire").text(this._status.flags.Player.FriendlyFire);$("#friendly_fire_penalty").text(this._status.flags.Player.FriendlyFirePenalty+" seconds");$("#auto_balance").text((this._status.flags.Player.AutoTeamBalance)?"Enabled":"Disabled")};Query.prototype._vehicleSettings=function(){var a=this;$("#vehicle_information").slideUp(1500,function(){$("#vehicle_information tr").remove();$.each((a)._status.flags.Team,function(b,c){$("#vehicle_information").append("<tr><td>"+b+"</td><td>"+c+" </td></tr>")});$("#vehicle_information").slideDown(1500)})};Query.prototype._gameSettings=function(){$("#game_settings tr").remove();$.each(this._status.flags.Game,function(a,b){if(b===1){b="Yes"}else{if(b===0){b="No"}}$("#game_settings").append("<tr><td>"+a+"</td><td>"+b+" </td></tr>")})};Query.prototype._playerActivitySpark=function(){this._activityHistory.push(this._status.numplayers);this._activityHistory.shift();$("#activity_spark").sparkline(this._activityHistory,{type:"bar",width:"70px",height:"20px",lineWidth:0,barColor:"#e1e1e1",chartRangeMin:0,chartRangeMax:16})};Query.prototype._audioCues=function(){if(!this._firstRun){this._announceScore()}this._announceGameOver();this._announceGameType();if(!this._soundQueueLock){this._processSoundQueue()}};Query.prototype._serverInformation=function(){$("#server_name").text(this._status.hostname);$("#server_ip").text(this._serverIP+":"+this._serverPort);$("#server_version").text(this._status.gamever);$("#player_count").text(this._status.numplayers+" / "+this._status.maxplayers);$("#game_mode").text(this._status.gametype);$("#game_variant").text(this._status.gamevariant);$("#current_map").text(this._status.mapname);$("#team_game").text((this._status.teamplay==1)?"Yes":"No");$("#dedicated").text((this._status.dedicated==1)?"Yes":"No");$("#password").text((this._status.password==1)?"Yes":"None")};Query.prototype._pageTitle=function(){$("title").text(this._status.mapname+", "+this._status.numplayers+"/"+this._status.maxplayers+" ("+this._serverIP+":"+this._serverPort+")")};Query.prototype._teamInformation=function(){if(this._status.teamplay!=this._prevStatus.teamplay||this._firstRun){$("#team_information").slideToggle(2000)}if(this._status.teamplay){var d=0,f=0,e,c,g,a,b;if(this._status.gametype==="Oddball"||this._status.gametype==="King"){this._status.score_t0=Math.floor(this._status.score_t0/30);this._status.score_t1=Math.floor(this._status.score_t1/30)}if(this._status.numplayers!=0){$.each(this._status.players,function(h,j){if(j.team==0){d++}else{f++}})}if(this._status.gametype==="CTF"){g=" captures"}else{if(this._status.gametype==="Slayer"||this._status.gametype==="Team Slayer"){g=" kills"}else{if(this._status.gametype=="Oddball"||this._status.gametype==="King"){this._status.fraglimit*=60;g=" seconds"}else{if(this._status.gametype==="Race"){g=" laps"}else{g=" unknown score unit"}}}}if(this._status.score_t0==0){a=0;c=0}else{a=Math.floor((this._status.score_t0/this._status.fraglimit)*100);c=Math.round((460*(a/100)))+40}if(this._status.score_t1==0){b=0;e=0}else{b=Math.floor((this._status.score_t1/this._status.fraglimit)*100);e=Math.round((460*(b/100)))+40}$("#blue .players").text(f+" / "+this._status.maxplayers);$("#red .players").text(d+" / "+this._status.maxplayers);$("#red .score").text(this._status.score_t0+g);$("#blue .score").text(this._status.score_t1+g);$("#red .bar").text(a+"%");$("#blue .bar").text(b+"%");if(this._status.score_t0!=this._prevStatus.score_t0){$("#red .bar").animate({width:c},1500)}if(this._status.score_t1!=this._prevStatus.score_t1){$("#blue .bar").animate({width:e},1500)}}};Query.prototype._saveStatus=function(){this._prevStatus=jQuery.extend(true,{},this._status);this._prevStatus.completion={redCompletion:0,blueCompletion:0}};Query.prototype._errorHandler=function(){if(this._status.errorcode==1){$.jGrowl(this._status.error+".",{life:5000});this.stop()}else{this._consecutiveFailures++;if(this._consecutiveFailures==1){$.jGrowl(this._status.error+". Retrying...",{header:"Retrying...",life:20000})}else{if(this._consecutiveFailures==10){$.jGrowl("The server failed to respond after 10 retries.",{header:"STOPPING UPDATES",life:20000});this.stop()}}}};Query.prototype._gameIcon=function(){var b=false,a;if(this._status.gametype!=this._prevStatus.gametype){switch(this._status.gametype){case"CTF":a=0;break;case"Slayer":a=1;break;case"King":a=3;break;case"Oddball":a=2;break;case"Race":a=13;break}b=true}if(this._status.gamevariant!=this._prevStatus.gamevariant){if(this._status.gamevariant.toLowerCase().indexOf("zombie")!=-1){a=7;b=true}}if(b){$("#game-icon").fadeOut(1500,function(){$("#game-icon").css("background-image","url('images/game_icons/"+a+".png')");$("#game-icon").fadeIn(1500)})}};Query.prototype._mapImages=function(){var a;if(this._status.mapname==="bloodgulch"||this._status.mapname==="deathisland"||this._status.mapname==="dangercanyon"||this._status.mapname==="timberland"||this._status.mapname==="gephyrophobia"||this._status.mapname==="icefields"||this._status.mapname==="infinity"||this._status.mapname==="sidewinder"||this._status.mapname==="boardingaction"||this._status.mapname==="putput"||this._status.mapname==="beavercreek"||this._status.mapname==="carousel"||this._status.mapname==="longest"||this._status.mapname==="hangemhigh"||this._status.mapname==="damnation"||this._status.mapname==="ratrace"||this._status.mapname==="chillout"||this._status.mapname==="talloniv"){a=this._status.mapname}else{a="unknown.png"}$("#banner").css("background-image","url('images/map_banners/"+a+".png')");$("#map_information img").fadeOut(2000,function(){$("#map_information img").attr("src","images/map_information/"+a+".png");$("#map_information img").fadeIn(2000)})};Query.prototype._announceScore=function(){if(this._status.gametype==="CTF"){if(this._status.score_t1!=this._prevStatus.score_t1){this._soundQueue[this._soundQueue.length]="blue_team_score"}else{if(this._status.score_t0!=this._prevStatus.score_t0){this._soundQueue[this._soundQueue.length]="red_team_score"}}}};Query.prototype._announceGameType=function(){var a;if(this._status.gametype!=this._prevStatus.gametype||this._status.teamplay!=this._prevStatus.teamplay){if(this._status.gametype==="CTF"){a="capture_the_flag"}else{if(this._status.gametype==="Race"){if(this._status.teamplay===1){a="team_race"}else{a="race"}}else{if(this._status.gametype==="King"){if(this._status.teamplay==1){a="team_king_of_the_hill"}else{a="king_of_the_hill"}}else{if(this._status.gametype==="Oddball"){if(this._status.teamplay==1){a="team_oddball"}else{a="oddball"}}else{if(this._status.gametype==="Slayer"){if(this._status.teamplay==1){a="team_slayer"}else{a="slayer"}}}}}}this._soundQueue[this._soundQueue.length]=a}};Query.prototype._announceGameOver=function(){if((this._status.redCompletion==100&&this._prevStatus.redCompletion!=100)||(this._status.blueCompletion==100&&this._prevStatus.blueCompletion!=100)){this._soundQueue[soundQueue.length]="game_over"}};Query.prototype.displayTabs=function(){$(function(){$("#tabs ul li").removeClass("active");$("#server_select").addClass("active");$("#query-tab").slideUp(600,function(){$("#tabs ul li").fadeIn(1000);$("#server-tab").slideDown(1000)})})};Query.prototype.stop=function(){clearInterval(this._intervalHandle)};Query.prototype._processSoundQueue=function(){if(this._soundQueue.length!=0){var a=this,b=soundManager.createSound({id:"sound",url:"audio/"+this._soundQueue[0]+".mp3",onfinish:function(){a._soundQueue.shift();a._processSoundQueue()}});b.play();this._soundQueueLock=true}else{this._soundQueueLock=false}};
